---
- name: Ensure MOK directory exists
  ansible.builtin.file:
    path: "{{ acer_battery_mok_dir }}"
    state: directory
    mode: '0700'
  become: true

- name: Check if MOK keys exist
  ansible.builtin.stat:
    path: "{{ acer_battery_mok_key }}"
  register: mok_key

- name: Check if MOK DER certificate exists
  ansible.builtin.stat:
    path: "{{ acer_battery_mok_der }}"
  register: mok_der

- name: Generate MOK keys if they don't exist
  ansible.builtin.command:
    cmd: >-
      openssl req -new -x509 -newkey rsa:2048
      -keyout {{ acer_battery_mok_key }}
      -out {{ acer_battery_mok_pub }}
      -nodes -days 36500
      -subj "/CN=Acer Battery Module/"
  when: not mok_key.stat.exists
  changed_when: true
  become: true

- name: Generate DER certificate for MOK enrollment
  ansible.builtin.command:
    cmd: openssl x509 -outform der -in {{ acer_battery_mok_pub }} -out {{ acer_battery_mok_der }}
  when: not mok_der.stat.exists
  changed_when: true
  become: true
