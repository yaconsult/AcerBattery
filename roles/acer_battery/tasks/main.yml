---
- name: Check if acer-wmi-battery directory exists
  stat:
    path: "/usr/src/acer-wmi-battery-{{ acer_battery_version }}"
  register: module_dir

- name: Clone acer-wmi-battery repository
  git:
    repo: "https://github.com/frederik-h/acer-wmi-battery.git"
    dest: "/usr/src/acer-wmi-battery-{{ acer_battery_version }}"
    version: "master"
    update: yes
    force: yes
  register: git_clone
  when: not module_dir.stat.exists

- name: Update acer-wmi-battery repository if it exists
  git:
    repo: "https://github.com/frederik-h/acer-wmi-battery.git"
    dest: "/usr/src/acer-wmi-battery-{{ acer_battery_version }}"
    version: "master"
    update: yes
  register: git_update
  when: module_dir.stat.exists
  notify: rebuild_module

- name: Install required packages
  package:
    name: "{{ item }}"
    state: present
    update_cache: yes
  loop: "{{ packages[ansible_os_family] }}"

- name: Copy DKMS configuration
  template:
    src: dkms.conf.j2
    dest: "/usr/src/acer-wmi-battery-{{ acer_battery_version }}/dkms.conf"
    mode: '0644'
  notify: rebuild_module

- name: Register with DKMS
  command:
    cmd: "dkms add -m acer-wmi-battery -v {{ acer_battery_version }}"
  args:
    creates: "/var/lib/dkms/acer-wmi-battery/{{ acer_battery_version }}/source"
  notify: rebuild_module

- name: Build and install module
  command:
    cmd: "dkms install -m acer-wmi-battery -v {{ acer_battery_version }}"
  args:
    creates: "/lib/modules/{{ ansible_kernel }}/updates/dkms/acer-wmi-battery.ko"
  notify: load_module

- name: Configure module autoload
  copy:
    content: "acer-wmi-battery"
    dest: /etc/modules-load.d/acer-wmi-battery.conf
    mode: '0644'
  notify: load_module

- name: Load module
  modprobe:
    name: acer-wmi-battery
    state: present

- name: Ensure module loads at boot
  lineinfile:
    path: /etc/modules-load.d/acer-wmi-battery.conf
    line: acer-wmi-battery
    create: yes
